
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../2021-10-03-network-down/" rel="prev"/>
<link href="../2021-12-22-preprod-crash/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.4" name="generator"/>
<title>Disk extension for preprod and containers prod (ovh2) - Open Food Facts Infrastructure documentation</title>
<link href="../../assets/stylesheets/main.240905d7.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#disk-extension-for-preprod-and-containers-prod-ovh2">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Open Food Facts Infrastructure documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Disk extension for preprod and containers prod (ovh2)
            
          </span>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Open Food Facts Infrastructure documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Open Food Facts Infrastructure documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        OpenFoodFacts Infrastructure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cicd/">
        Continous Integration and Continuous Delivery
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../discourse/">
        Discourse
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../docker/">
        Docker at Open Food Facts
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../docker_architecture/">
        Docker architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../docker_onboarding/">
        Onboarding
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../folksonomy/">
        Folksonomy API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../free-datacenter/">
        Free Datacenter
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../linux-server/">
        Linux server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mail/">
        Mail on Open Food Facts infrastructure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../matomo/">
        Matomo
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nginx-reverse-proxy/">
        NGINX Reverse proxy (OVH)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../observability/">
        Observability
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../odoo/">
        Odoo: our relationship management (connect.openfoodfacts.org)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../prod-architecture/">
        Production architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../producers_sftp/">
        Producers SFTP
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../promox/">
        Proxmox
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../slackin/">
        auto Slack invitation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../zammad/">
        Zammad
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../zfs-overview/">
        ZFS overview
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_21" type="checkbox"/>
<label class="md-nav__link" for="__nav_21" id="__nav_21_label" tabindex="0">
          Reports
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_21_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_21">
<span class="md-nav__icon md-icon"></span>
          Reports
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../2021-02-22-matomo-install/">
        Matomo install
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2021-10-03-network-down/">
        [Postmortem] OpenFoodFacts.net down (#1)
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Disk extension for preprod and containers prod (ovh2)
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Disk extension for preprod and containers prod (ovh2)
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshoting">
    Snapshoting
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#extending-partition-size">
    Extending partition size
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2021-12-22-preprod-crash/">
        Preprod crash 2021 12
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-02-18-ovh-reverse-proxy-down/">
        [Postmortem] Reverse proxy down
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-02-proxmox-mail-gateway-install/">
        Install of proxmox gateway server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-02-remove-containers-ovh1/">
        2022-02 Removing some containers on ovh1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-03-03-zammad-elasticsearch-not-running/">
        Elasticsearch not running on Zammad
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-07-08-journey-to-deploy-off-search/">
        Deploying openfoodfacts-search to staging
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-07-11-infra-workshop/">
        Infrastructure future - workshop on 11th July 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-07-kibana-down-es-circuit-breaking-exception/">
        Kibana down because of Elasticsearch circuit_breaking_exception
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-08-17-openfoodfacts-net-unreachable/">
        2022-08-17 openfoodfacts.net unreachable
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2022-11-09-monitoring-move-to-own-vm/">
        2022-11 moving monitoring to its own machine
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2023-02-13-zammad-down/">
        2023-02-13 Zammad down
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2023-02-16-off2-shutdown/">
        2023 02 16 off2 shutdown
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2023-02-17-off2-upgrade/">
        2023-02-17 Off2 Upgrade
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2023-02-24-zfs-introduction/">
        2023 02 24 zfs introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2023-03-14-off2-reinstall/">
        2023-03 OFF2 reinstall
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#snapshoting">
    Snapshoting
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#extending-partition-size">
    Extending partition size
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="disk-extension-for-preprod-and-containers-prod-ovh2">Disk extension for preprod and containers prod (ovh2)<a class="headerlink" href="#disk-extension-for-preprod-and-containers-prod-ovh2" title="Permanent link">#</a></h1>
<p>We got alerts on low disk space on preprod VM (dockers (200) on ovh2)</p>
<p>We added disk space in proxmox to this machine and the container machine but we still add to make it available on the system side.</p>
<p>Operation was done on ovh2, VM dockers (200) and VM dockers-prod (201)</p>
<h2 id="snapshoting">Snapshoting<a class="headerlink" href="#snapshoting" title="Permanent link">#</a></h2>
<p>Before this delicate operation, we snapshoted the VM in proxmox.</p>
<h2 id="extending-partition-size">Extending partition size<a class="headerlink" href="#extending-partition-size" title="Permanent link">#</a></h2>
<p>This is the commands we run to make it happens.</p>
<p>Install tools:</p>
<div class="highlight"><pre><span></span><code>apt install parted etckeeper
</code></pre></div>
<p>The swap partition is after the main partition, so we will have to remove it, resize main partition and recreate it.</p>
<p>Turn swap off:
<div class="highlight"><pre><span></span><code>swapoff -a
</code></pre></div></p>
<p>Edit partition.</p>
<div class="highlight"><pre><span></span><code>parted /dev/sda
# change unit to sectors
(parted) u
Unit?  [compact]? s
# print partition table
(parted) p
Number  Start   End    Size    Type      File system     Flags
 1      1049kB  274GB  274GB   primary   ext4            boot
 2      274GB   275GB  1022MB  extended
 5      274GB   275GB  1022MB  logical   linux-swap(v1)
# note tha swap partition is to 534872062 536868863 (1996802 sectores in size)
# remove swap partitions
(parted) rm 5
(parted) rm 2
# print to check
(parted) p
Number  Start  End         Size        Type     File system  Flags
 1      2048s  534870015s  534867968s  primary  ext4         boot
# resize partition 1, leaving space for swap
(parted) resizepart 1 -1996801
Warning: Partition /dev/sda1 is being used. Are you sure you want to continue?
Yes/No? y
# print
umber  Start  End         Size        Type     File system  Flags
 1      2048s  627148799s  627146752s  primary  ext4         boot
# recreate swap (Start is end of part 1 + 1)
(parted) mkpart
Partition type?  primary/extended? primary
File system type?  [ext2]? linux-swap
Start? 836864000
End? -1s
(parted) quit
</code></pre></div>
<blockquote>
<p>:pencil: Note:
1. we switch units to sectors because
   it helps having better aligned partitions
   (by multiples of 2048 in this case)
2. The swap partition was on an extended partition,
   but we put it back as a simple partition</p>
</blockquote>
<p>We recreated swap, now we have to format it:
<div class="highlight"><pre><span></span><code>mkswap /dev/sda2
</code></pre></div></p>
<p>show new uids:
<div class="highlight"><pre><span></span><code>blkid

/dev/sda1: UUID="082b4523-f4d6-4d39-b5dd-48c5bdba2541" BLOCK_SIZE="4096" TYPE="ext4" PARTUUID="1a39b366-01"
/dev/sr0: BLOCK_SIZE="2048" UUID="2021-08-14-10-10-00-00" LABEL="Debian 11.0.0 amd64 n" TYPE="iso9660" PTUUID="3c15dbf8" PTTYPE="dos"
/dev/sda2: UUID="f8e99f04-88eb-4550-9308-10a470175e45" TYPE="swap" PARTUUID="1a39b366-02"
</code></pre></div></p>
<p>Change /etc/fstab accordingly (<code>sda1</code> UUID did not change, only swap changed):</p>
<div class="highlight"><pre><span></span><code># / was on /dev/sda1 during installation
UUID=082b4523-f4d6-4d39-b5dd-48c5bdba2541 /               ext4    errors=remount-ro 0       1
# swap was on /dev/sda2 during installation
UUID=f8e99f04-88eb-4550-9308-10a470175e45 none            swap    sw              0       0
</code></pre></div>
<p>We should have booked our operation in etckeeper 
(not done on dockers-prod, etckeeper was not yet installed)
<div class="highlight"><pre><span></span><code>etckeeper commit "changed partition size"
</code></pre></div></p>
<p>Now we resized the partition, but we have to resize the filesystem. Let's resize sda1:
<div class="highlight"><pre><span></span><code>resize2fs /dev/sda1
</code></pre></div></p>
<p>Reactivate swap:
<div class="highlight"><pre><span></span><code>swapon -a
</code></pre></div></p>
<p>Let's see our changes:</p>
<div class="highlight"><pre><span></span><code>df -h /
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       294G  187G   93G  67% /
</code></pre></div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.19047be9.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>