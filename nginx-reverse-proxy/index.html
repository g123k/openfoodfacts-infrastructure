
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../matomo/" rel="prev"/>
<link href="../observability/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.5" name="generator"/>
<title>NGINX Reverse proxy (OVH) - Open Food Facts Infrastructure documentation</title>
<link href="../assets/stylesheets/main.7a7fce14.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#nginx-reverse-proxy-ovh">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" data-md-component="logo" href=".." title="Open Food Facts Infrastructure documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              NGINX Reverse proxy (OVH)
            
          </span>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" data-md-component="logo" href=".." title="Open Food Facts Infrastructure documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Open Food Facts Infrastructure documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        OpenFoodFacts Infrastructure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cicd/">
        Continous Integration and Continuous Delivery
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../discourse/">
        Discourse
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docker/">
        Docker at Open Food Facts
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docker_architecture/">
        Docker architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docker_onboarding/">
        Onboarding
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../folksonomy/">
        Folksonomy API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-datacenter/">
        Free Datacenter
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../linux-server/">
        Linux server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mail/">
        Mail on Open Food Facts infrastructure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../matomo/">
        Matomo
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          NGINX Reverse proxy (OVH)
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        NGINX Reverse proxy (OVH)
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#network-specific-interface">
    Network specific interface
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configuring-a-new-service">
    Configuring a new service
  </a>
<nav aria-label="Configuring a new service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#steps-to-create-nginx-configuration">
    Steps to create Nginx configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-https">
    Adding https
  </a>
<nav aria-label="Adding https" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#multiple-domains">
    Multiple domains
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#etc-keeper">
    Etc Keeper
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../observability/">
        Observability
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../odoo/">
        Odoo: our relationship management (connect.openfoodfacts.org)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../prod-architecture/">
        Production architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../producers_sftp/">
        Producers SFTP
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../promox/">
        Proxmox
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../slackin/">
        auto Slack invitation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zammad/">
        Zammad
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zfs-overview/">
        ZFS overview
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_21" type="checkbox"/>
<label class="md-nav__link" for="__nav_21" id="__nav_21_label" tabindex="0">
          Reports
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_21_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_21">
<span class="md-nav__icon md-icon"></span>
          Reports
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-02-22-matomo-install/">
        Matomo install
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-10-03-network-down/">
        [Postmortem] OpenFoodFacts.net down (#1)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-12-21-disk-extension/">
        Disk extension for preprod and containers prod (ovh2)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-12-22-preprod-crash/">
        Preprod crash 2021 12
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-02-18-ovh-reverse-proxy-down/">
        [Postmortem] Reverse proxy down
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-02-proxmox-mail-gateway-install/">
        Install of proxmox gateway server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-02-remove-containers-ovh1/">
        2022-02 Removing some containers on ovh1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-03-03-zammad-elasticsearch-not-running/">
        Elasticsearch not running on Zammad
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-07-08-journey-to-deploy-off-search/">
        Deploying openfoodfacts-search to staging
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-07-11-infra-workshop/">
        Infrastructure future - workshop on 11th July 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-07-kibana-down-es-circuit-breaking-exception/">
        Kibana down because of Elasticsearch circuit_breaking_exception
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-08-17-openfoodfacts-net-unreachable/">
        2022-08-17 openfoodfacts.net unreachable
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-11-09-monitoring-move-to-own-vm/">
        2022-11 moving monitoring to its own machine
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-13-zammad-down/">
        2023-02-13 Zammad down
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-16-off2-shutdown/">
        2023 02 16 off2 shutdown
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-17-off2-upgrade/">
        2023-02-17 Off2 Upgrade
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-24-zfs-introduction/">
        2023 02 24 zfs introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-03-14-off2-reinstall/">
        2023-03 OFF2 reinstall
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#network-specific-interface">
    Network specific interface
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configuring-a-new-service">
    Configuring a new service
  </a>
<nav aria-label="Configuring a new service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#steps-to-create-nginx-configuration">
    Steps to create Nginx configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-https">
    Adding https
  </a>
<nav aria-label="Adding https" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#multiple-domains">
    Multiple domains
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#etc-keeper">
    Etc Keeper
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="nginx-reverse-proxy-ovh">NGINX Reverse proxy (OVH)<a class="headerlink" href="#nginx-reverse-proxy-ovh" title="Permanent link">#</a></h1>
<p>At OVH and at Free we have a LXC container dedicated to reverse proxy http/https applications. It serves applications that are located in servers at the same provider (and same Proxmox cluster).</p>
<h2 id="network-specific-interface">Network specific interface<a class="headerlink" href="#network-specific-interface" title="Permanent link">#</a></h2>
<p>It as a specific network configurations with two ethernet address:
* one internal, to communicate with other VMs
* one which is bridged on host network card, with ip fail over mechanism.</p>
<p><strong>Important</strong>: only the public ip should have a gateway <sup id="fnref:proxmox_multiple_gateway"><a class="footnote-ref" href="#fn:proxmox_multiple_gateway">1</a></sup></p>
<h2 id="configuring-a-new-service">Configuring a new service<a class="headerlink" href="#configuring-a-new-service" title="Permanent link">#</a></h2>
<p>To make a new service, hosted on Proxmox, available you need to:</p>
<ul>
<li>have this service available on proxmox internal network</li>
<li>in the DNS, CNAME you service name to<ul>
<li><code>proxy1.openfoodfacts.org</code> for OVH (ovh1..3)</li>
<li><code>proxy2.openfoodfacts.org</code> for Free (off1..2)</li>
</ul>
</li>
<li>write a configuration on nginx for this service</li>
<li>eventually add https</li>
</ul>
<h3 id="steps-to-create-nginx-configuration">Steps to create Nginx configuration<a class="headerlink" href="#steps-to-create-nginx-configuration" title="Permanent link">#</a></h3>
<p>Imagine we have to configure <strong>my-service.openfoodfacts.net</strong>, to route request to container <code>222</code>, port <code>8888</code>.</p>
<p>You will have to be root to do that.</p>
<p>Login on the Nginx reverse proxy container (101) and launch a Bash session as root.</p>
<p>Create the basic configuration file for your service in <code>/etc/nginx/conf.d</code> directory, named after your service, eg. <code>my-service.openfoodfacts.net.conf</code>.</p>
<p><strong>Important</strong>: your file has to ends with <code>.conf</code> to be taken into account.</p>
<p>It's a good idea to first test it exists, using nc and curl:</p>
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span>-vz<span class="w"> </span><span class="m">10</span>.1.0.222<span class="w"> </span><span class="m">8888</span>
curl<span class="w">  </span>http://10.1.0.222:8888
</code></pre></div>
<p>Create a config, say:</p>
<div class="highlight"><pre><span></span><code><span class="k">server</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w">  </span><span class="s">my-service.openfoodfacts.net</span><span class="p">;</span>

<span class="w">    </span><span class="kn">access_log</span><span class="w">  </span><span class="s">/var/log/nginx/my-service.off.net.log</span><span class="w">  </span><span class="s">main</span><span class="p">;</span>
<span class="w">    </span><span class="kn">error_log</span><span class="w">   </span><span class="s">/var/log/nginx/my-service.off.net.err</span><span class="p">;</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://10.1.0.222:8888</span><span class="nv">$request_uri</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w"> </span><span class="s">https</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_read_timeout</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span>
<span class="w">        </span><span class="kn">client_max_body_size</span><span class="w"> </span><span class="s">512M</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>If you need more <a href="https://nginx.org/en/docs/">nginx docs are here</a></p>
<p>We test nginx configuration is ok (<strong>Mandatory</strong>)<sup id="fnref:test-nginx"><a class="footnote-ref" href="#fn:test-nginx">2</a></sup>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>nginx<span class="w"> </span>-t
nginx:<span class="w"> </span>the<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span>syntax<span class="w"> </span>is<span class="w"> </span>ok
nginx:<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span><span class="nb">test</span><span class="w"> </span>is<span class="w"> </span>successful
</code></pre></div>
<p>if it's ok, we reload.
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx
</code></pre></div></p>
<p>Next step is probably to setup https (putting something in http should be an exception, with good reason for that !)
Otherwise jump to <a href="#etc-keeper">EtcKeeper</a></p>
<h3 id="adding-https">Adding https<a class="headerlink" href="#adding-https" title="Permanent link">#</a></h3>
<p>Most of the time https certificates are managed on the nginx reverse proxy VM. Here is how to configure them to enable https.</p>
<p>We use certbot to manage certificates.</p>
<p>First prepare the service definition to answer on port 443 and 80. That is:</p>
<ul>
<li>change your current configuration to listen on 443:
  <div class="highlight"><pre><span></span><code><span class="k">{</span>
<span class="w">  </span><span class="s">server</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="p">;</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="p">;</span>
<span class="w">  </span><span class="kn">server_name</span><span class="w">  </span><span class="s">my-service.openfoodfacts.net</span><span class="p">;</span>
<span class="w">  </span><span class="kn">…</span>
</code></pre></div></li>
<li>but after it, add a new bare section for port 80:
  <div class="highlight"><pre><span></span><code><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span>
<span class="w">  </span><span class="kn">server_name</span><span class="w">  </span><span class="s">my-service.openfoodfacts.net</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<p>We will first validate our config using <code>--test-cert</code> option (<strong>WARNING</strong> only skip this part if you really are used to certbot and nginx configuration, as after five tentatives, we won't be able to renew any certificates on the domain for one full week, and if you do too much error, the IP itself might be out of limit, see <a href="https://letsencrypt.org/docs/rate-limits/">letsencrypt Rate limits</a>)</p>
<div class="highlight"><pre><span></span><code>$ certbot --test-cert -d my-service.openfoodfacts.net
…
Enter email address (used for urgent renewal and security notices) (Enter 'c' to
cancel): root@openfoodfacts.org
…
terms of service…
(A)gree/(C)ancel: A
…
share email…
(Y)es/(N)o: n

Obtaining a new certificate
Performing the following challenges:
http-01 challenge for my-service.openfoodfacts.net
Waiting for verification...
Cleaning up challenges
Deploying Certificate to VirtualHost /etc/nginx/conf.d/my-service.openfoodfacts.net.conf
</code></pre></div>
<p><strong>Note:</strong> verify it's the right file which has been impacted ! If it's not you may have the option to restore the file with <code>git checkout wrong-touched-file</code> (but look before with <code>git status</code>)</p>
<p>Test it's working (apart from the security alert in your browser, because certificate is from an unknown issuer).</p>
<p>Then install the real certificate (you get the first section if you first did a test certificate):</p>
<div class="highlight"><pre><span></span><code>$ certbot -d my-service.openfoodfacts.net
1: Attempt to reinstall this existing certificate
2: Renew &amp; replace the cert (limit ~5 per 7 days)
Select … [enter] (press 'c' to cancel): 2
…
Enter email address (used for urgent renewal and security notices) (Enter 'c' to
cancel): root@openfoodfacts.org
…
terms of service…
(A)gree/(C)ancel: A
…
share email…
(Y)es/(N)o: n

Obtaining a new certificate
Performing the following challenges:
http-01 challenge for my-service.openfoodfacts.net
Waiting for verification...
Cleaning up challenges
Deploying Certificate to VirtualHost /etc/nginx/conf.d/my-service.openfoodfacts.net.conf
</code></pre></div>
<p>Test again if it's working</p>
<h4 id="multiple-domains">Multiple domains<a class="headerlink" href="#multiple-domains" title="Permanent link">#</a></h4>
<p>If you're in the case where same configuration must serve multiple domains, like ui.my-site.openfoodfacts.net and api.my-site.openfoodfacts.net,
simply add all those domain to the certbot command with the <code>-d</code> parameters.</p>
<p>For example:</p>
<div class="highlight"><pre><span></span><code>certbot<span class="w"> </span>-d<span class="w"> </span>ui.my-site.openfoodfacts.net<span class="w"> </span>-d<span class="w"> </span>api.my-site.openfoodfacts.net<span class="w"> </span>-d<span class="w"> </span>my-site.openfoodfacts.net
</code></pre></div>
<p>If a certificate already exists for a domain, certbot will propose to extend it with the other domains.</p>
<h3 id="etc-keeper">Etc Keeper<a class="headerlink" href="#etc-keeper" title="Permanent link">#</a></h3>
<p>We use <a href="../linux-server/#etckeeper">etckeeper</a>
Do not forget to commit your changes:</p>
<div class="highlight"><pre><span></span><code>etckeeper<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">"Configured my-service.openfoodfacts.net"</span>
</code></pre></div>
<p>Now we are done 🎉</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:proxmox_multiple_gateway">
<p>The default proxmox interface does not offer options to indicate which gateway should be the default gateway, and the public ip needs to have its gateway as the default one, and there is no trivial way to achieve this reliably and elegantly, thus the best solution is to have only one gateway. See also <a href="../reports/2022-02-18-ovh-reverse-proxy-down/">ovh reverse proxy incident of 2022-02-18</a> <a class="footnote-backref" href="#fnref:proxmox_multiple_gateway" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:test-nginx">
<p>the nginx script will normally do the check before trying to restart nginx, but this way you are able to also see warnings. <a class="footnote-backref" href="#fnref:test-nginx" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.407015b8.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>