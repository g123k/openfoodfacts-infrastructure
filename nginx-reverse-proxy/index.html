
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../matomo/">
      
      
        <link rel="next" href="../observability/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.2">
    
    
      
        <title>NGINX Reverse proxy (OVH) - Open Food Facts Infrastructure documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f56500e0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nginx-reverse-proxy-ovh" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              NGINX Reverse proxy (OVH)
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Open Food Facts Infrastructure documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        OpenFoodFacts Infrastructure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../cicd/" class="md-nav__link">
        Continous Integration and Continuous Delivery
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../discourse/" class="md-nav__link">
        Discourse
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        Docker at Open Food Facts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../docker_architecture/" class="md-nav__link">
        Docker architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../docker_onboarding/" class="md-nav__link">
        Onboarding
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../folksonomy/" class="md-nav__link">
        Folksonomy API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../linux-server/" class="md-nav__link">
        Linux server
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mail/" class="md-nav__link">
        Mail on Open Food Facts infrastructure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../matomo/" class="md-nav__link">
        Matomo
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          NGINX Reverse proxy (OVH)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        NGINX Reverse proxy (OVH)
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#network-specific-interface" class="md-nav__link">
    Network specific interface
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-a-new-service" class="md-nav__link">
    Configuring a new service
  </a>
  
    <nav class="md-nav" aria-label="Configuring a new service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#steps-to-create-nginx-configuration" class="md-nav__link">
    Steps to create Nginx configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-https" class="md-nav__link">
    Adding https
  </a>
  
    <nav class="md-nav" aria-label="Adding https">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiple-domains" class="md-nav__link">
    Multiple domains
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etc-keeper" class="md-nav__link">
    Etc Keeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        Observability
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../odoo/" class="md-nav__link">
        Odoo: our relationship management (connect.openfoodfacts.org)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../producers_sftp/" class="md-nav__link">
        Producers SFTP
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../promox/" class="md-nav__link">
        Proxmox
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../zammad/" class="md-nav__link">
        Zammad
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_17" type="checkbox" id="__nav_17" >
      
      
      
      
        <label class="md-nav__link" for="__nav_17">
          Reports
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reports" data-md-level="1">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          Reports
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2021-02-22-matomo-install/" class="md-nav__link">
        Matomo install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2021-10-03-network-down/" class="md-nav__link">
        [Postmortem] OpenFoodFacts.net down (#1)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2021-12-21-disk-extension/" class="md-nav__link">
        Disk extension for preprod and containers prod (ovh2)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2021-12-22-preprod-crash/" class="md-nav__link">
        Preprod crash 2021 12
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-02-18-ovh-reverse-proxy-down/" class="md-nav__link">
        [Postmortem] Reverse proxy down
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-02-proxmox-mail-gateway-install/" class="md-nav__link">
        Install of proxmox gateway server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-02-remove-containers-ovh1/" class="md-nav__link">
        2022-02 Removing some containers on ovh1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-03-03-zammad-elasticsearch-not-running/" class="md-nav__link">
        Elasticsearch not running on Zammad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-07-08-journey-to-deploy-off-search/" class="md-nav__link">
        Deploying openfoodfacts-search to staging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-07-11-infra-workshop/" class="md-nav__link">
        Infrastructure future - workshop on 11th July 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-07-kibana-down-es-circuit-breaking-exception/" class="md-nav__link">
        Kibana down because of Elasticsearch circuit_breaking_exception
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-08-17-openfoodfacts-net-unreachable/" class="md-nav__link">
        2022-08-17 openfoodfacts.net unreachable
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reports/2022-11-09-monitoring-move-to-own-vm/" class="md-nav__link">
        2022-11 moving monitoring to its own machine
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#network-specific-interface" class="md-nav__link">
    Network specific interface
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-a-new-service" class="md-nav__link">
    Configuring a new service
  </a>
  
    <nav class="md-nav" aria-label="Configuring a new service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#steps-to-create-nginx-configuration" class="md-nav__link">
    Steps to create Nginx configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-https" class="md-nav__link">
    Adding https
  </a>
  
    <nav class="md-nav" aria-label="Adding https">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiple-domains" class="md-nav__link">
    Multiple domains
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etc-keeper" class="md-nav__link">
    Etc Keeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="nginx-reverse-proxy-ovh">NGINX Reverse proxy (OVH)<a class="headerlink" href="#nginx-reverse-proxy-ovh" title="Permanent link">#</a></h1>
<p>At OVH we have a lxc container dedicated to reverse proxy http/https applications.</p>
<h2 id="network-specific-interface">Network specific interface<a class="headerlink" href="#network-specific-interface" title="Permanent link">#</a></h2>
<p>It as a specific network configurations with two ethernet address:
* one internal, to communicate with other VMs
* one which is bridged on host network card, with ip fail over mechanism.</p>
<p><strong>Important</strong>: only the public ip should have a gateway <sup id="fnref:proxmox_multiple_gateway"><a class="footnote-ref" href="#fn:proxmox_multiple_gateway">1</a></sup></p>
<h2 id="configuring-a-new-service">Configuring a new service<a class="headerlink" href="#configuring-a-new-service" title="Permanent link">#</a></h2>
<p>To make a new service, hosted on proxmox, available you needs to:</p>
<ul>
<li>have this service available on proxmox internal network</li>
<li>in the DNS, CNAME you service name to <code>proxy1.openfoodfacts.org</code></li>
<li>write a configuration on nginx for this service</li>
<li>eventually add https</li>
</ul>
<h3 id="steps-to-create-nginx-configuration">Steps to create Nginx configuration<a class="headerlink" href="#steps-to-create-nginx-configuration" title="Permanent link">#</a></h3>
<p>we will imagine we configure <strong>my-service.openfoodfacts.net</strong></p>
<p>You will have to be root to do that.</p>
<p>Login on container (101) and start a root bash.</p>
<p>Create the basic configuration file for your service in <code>/etc/nginx/conf.d</code> named <code>my-service.openfoodfacts.net.conf</code> on machine <code>222</code>, port <code>8888</code>.</p>
<p><strong>Important</strong>: your file has to ends with <code>.conf</code> to be taken into account.</p>
<p>It's a good idea to first test it exists, using nc and curl:</p>
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span>-vz<span class="w"> </span><span class="m">10</span>.1.0.222<span class="w"> </span><span class="m">8888</span>
curl<span class="w">  </span>http://10.1.0.222:8888
</code></pre></div>
<p>Create a config, say:</p>
<div class="highlight"><pre><span></span><code><span class="k">server</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w">  </span><span class="s">my-service.openfoodfacts.net</span><span class="p">;</span>

<span class="w">    </span><span class="kn">access_log</span><span class="w">  </span><span class="s">/var/log/nginx/my-service.off.net.log</span><span class="w">  </span><span class="s">main</span><span class="p">;</span>
<span class="w">    </span><span class="kn">error_log</span><span class="w">   </span><span class="s">/var/log/nginx/my-service.off.net.err</span><span class="p">;</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://10.1.0.222:8888</span><span class="nv">$request_uri</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w"> </span><span class="s">https</span><span class="p">;</span>
<span class="w">        </span><span class="kn">proxy_read_timeout</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span>
<span class="w">        </span><span class="kn">client_max_body_size</span><span class="w"> </span><span class="s">512M</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>If you need more <a href="https://nginx.org/en/docs/">nginx docs are here</a></p>
<p>We test nginx configuration is ok (<strong>Mandatory</strong>)<sup id="fnref:test-nginx"><a class="footnote-ref" href="#fn:test-nginx">2</a></sup>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>nginx<span class="w"> </span>-t
nginx:<span class="w"> </span>the<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span>syntax<span class="w"> </span>is<span class="w"> </span>ok
nginx:<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span><span class="nb">test</span><span class="w"> </span>is<span class="w"> </span>successful
</code></pre></div>
<p>if it's ok, we reload.
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx
</code></pre></div></p>
<p>Next step is probably to setup https (putting something in http should be an exception, with good reason for that !)
Otherwise jump to <a href="#etc-keeper">EtcKeeper</a></p>
<h3 id="adding-https">Adding https<a class="headerlink" href="#adding-https" title="Permanent link">#</a></h3>
<p>Most of the time https certificates are managed on the nginx reverse proxy VM. Here is how to configure them to enable https.</p>
<p>We use certbot to manage certificates.</p>
<p>First prepare the service definition to answer on port 443 and 80. That is:</p>
<ul>
<li>change your current configuration to listen on 443:
  <div class="highlight"><pre><span></span><code><span class="k">{</span>
<span class="w">  </span><span class="s">server</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="p">;</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="p">;</span>
<span class="w">  </span><span class="kn">server_name</span><span class="w">  </span><span class="s">my-service.openfoodfacts.net</span><span class="p">;</span>
<span class="w">  </span><span class="kn">…</span>
</code></pre></div></li>
<li>but after it, add a new bare section for port 80:
  <div class="highlight"><pre><span></span><code><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">  </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span>
<span class="w">  </span><span class="kn">server_name</span><span class="w">  </span><span class="s">my-service.openfoodfacts.net</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<p>We will first validate our config using <code>--test-cert</code> option (<strong>WARNING</strong> only skip this part if you really are used to certbot and nginx configuration, as after five tentatives, we won't be able to renew any certificates on the domain for one full week, and if you do too much error, the IP itself might be out of limit, see <a href="https://letsencrypt.org/docs/rate-limits/">letsencrypt Rate limits</a>)</p>
<div class="highlight"><pre><span></span><code>$ certbot --test-cert -d my-service.openfoodfacts.net
…
Enter email address (used for urgent renewal and security notices) (Enter &#39;c&#39; to
cancel): root@openfoodfacts.org
…
terms of service…
(A)gree/(C)ancel: A
…
share email…
(Y)es/(N)o: n

Obtaining a new certificate
Performing the following challenges:
http-01 challenge for my-service.openfoodfacts.net
Waiting for verification...
Cleaning up challenges
Deploying Certificate to VirtualHost /etc/nginx/conf.d/my-service.openfoodfacts.net.conf
</code></pre></div>
<p><strong>Note:</strong> verify it's the right file which has been impacted ! If it's not you may have the option to restore the file with <code>git checkout wrong-touched-file</code> (but look before with <code>git status</code>)</p>
<p>Test it's working (apart from the security alert in your browser, because certificate is from an unknown issuer).</p>
<p>Then install the real certificate (you get the first section if you first did a test certificate):</p>
<div class="highlight"><pre><span></span><code>$ certbot -d my-service.openfoodfacts.net
1: Attempt to reinstall this existing certificate
2: Renew &amp; replace the cert (limit ~5 per 7 days)
Select … [enter] (press &#39;c&#39; to cancel): 2
…
Enter email address (used for urgent renewal and security notices) (Enter &#39;c&#39; to
cancel): root@openfoodfacts.org
…
terms of service…
(A)gree/(C)ancel: A
…
share email…
(Y)es/(N)o: n

Obtaining a new certificate
Performing the following challenges:
http-01 challenge for my-service.openfoodfacts.net
Waiting for verification...
Cleaning up challenges
Deploying Certificate to VirtualHost /etc/nginx/conf.d/my-service.openfoodfacts.net.conf
</code></pre></div>
<p>Test again if it's working</p>
<h4 id="multiple-domains">Multiple domains<a class="headerlink" href="#multiple-domains" title="Permanent link">#</a></h4>
<p>If you're in the case where same configuration must serve multiple domains, like ui.my-site.openfoodfacts.net and api.my-site.openfoodfacts.net,
simply add all those domain to the certbot command with the <code>-d</code> parameters.</p>
<p>For example:</p>
<div class="highlight"><pre><span></span><code>certbot<span class="w"> </span>-d<span class="w"> </span>ui.my-site.openfoodfacts.net<span class="w"> </span>-d<span class="w"> </span>api.my-site.openfoodfacts.net<span class="w"> </span>-d<span class="w"> </span>my-site.openfoodfacts.net
</code></pre></div>
<p>If a certificate already exists for a domain, certbot will propose to extend it with the other domains.</p>
<h3 id="etc-keeper">Etc Keeper<a class="headerlink" href="#etc-keeper" title="Permanent link">#</a></h3>
<p>We use <a href="../linux-server/#etckeeper">etckeeper</a>
Do not forget to commit your changes:</p>
<div class="highlight"><pre><span></span><code>etckeeper<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Configured my-service.openfoodfacts.net&quot;</span>
</code></pre></div>
<p>Now we are done 🎉</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:proxmox_multiple_gateway">
<p>The default proxmox interface does not offer options to indicate which gateway should be the default gateway, and the public ip needs to have its gateway as the default one, and there is no trivial way to achieve this reliably and elegantly, thus the best solution is to have only one gateway. See also <a href="../reports/2022-02-18-ovh-reverse-proxy-down/">ovh reverse proxy incident of 2022-02-18</a>&#160;<a class="footnote-backref" href="#fnref:proxmox_multiple_gateway" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:test-nginx">
<p>the nginx script will normally do the check before trying to restart nginx, but this way you are able to also see warnings.&#160;<a class="footnote-backref" href="#fnref:test-nginx" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
    
  </body>
</html>