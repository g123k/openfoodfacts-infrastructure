
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../cicd/" rel="prev"/>
<link href="../docker/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.6" name="generator"/>
<title>Discourse - Open Food Facts Infrastructure documentation</title>
<link href="../assets/stylesheets/main.ded33207.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#discourse">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" data-md-component="logo" href=".." title="Open Food Facts Infrastructure documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Discourse
            
          </span>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" data-md-component="logo" href=".." title="Open Food Facts Infrastructure documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Open Food Facts Infrastructure documentation
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        OpenFoodFacts Infrastructure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cicd/">
        Continous Integration and Continuous Delivery
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Discourse
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Discourse
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#software-installation">
    Software installation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mail">
    Mail
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#software-update">
    Software update
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#analytics-with-matomo">
    Analytics with Matomo
  </a>
<nav aria-label="Analytics with Matomo" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#setup">
    setup
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#events-plugin">
    Events plugin
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docker/">
        Docker at Open Food Facts
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docker_architecture/">
        Docker architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docker_onboarding/">
        Onboarding
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../folksonomy/">
        Folksonomy API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-datacenter/">
        Free Datacenter
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../linux-server/">
        Linux server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mail/">
        Mail on Open Food Facts infrastructure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../matomo/">
        Matomo
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mongodb/">
        MongoDB
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../nginx-reverse-proxy/">
        NGINX Reverse proxy (OVH)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../observability/">
        Observability
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../odoo/">
        Odoo: our relationship management (connect.openfoodfacts.org)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../prod-architecture/">
        Production architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../producers_sftp/">
        Producers SFTP
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../promox/">
        Proxmox
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../slackin/">
        auto Slack invitation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zammad/">
        Zammad
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zfs-overview/">
        ZFS overview
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_22" type="checkbox"/>
<label class="md-nav__link" for="__nav_22" id="__nav_22_label" tabindex="0">
          Reports
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_22_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_22">
<span class="md-nav__icon md-icon"></span>
          Reports
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-02-22-matomo-install/">
        Matomo install
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-10-03-network-down/">
        [Postmortem] OpenFoodFacts.net down (#1)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-12-21-disk-extension/">
        Disk extension for preprod and containers prod (ovh2)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2021-12-22-preprod-crash/">
        Preprod crash 2021 12
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-02-18-ovh-reverse-proxy-down/">
        [Postmortem] Reverse proxy down
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-02-proxmox-mail-gateway-install/">
        Install of proxmox gateway server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-02-remove-containers-ovh1/">
        2022-02 Removing some containers on ovh1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-03-03-zammad-elasticsearch-not-running/">
        Elasticsearch not running on Zammad
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-07-08-journey-to-deploy-off-search/">
        Deploying openfoodfacts-search to staging
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-07-11-infra-workshop/">
        Infrastructure future - workshop on 11th July 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-07-kibana-down-es-circuit-breaking-exception/">
        Kibana down because of Elasticsearch circuit_breaking_exception
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-08-17-openfoodfacts-net-unreachable/">
        2022-08-17 openfoodfacts.net unreachable
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2022-11-09-monitoring-move-to-own-vm/">
        2022-11 moving monitoring to its own machine
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-13-zammad-down/">
        2023-02-13 Zammad down
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-16-off2-shutdown/">
        2023 02 16 off2 shutdown
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-17-off2-upgrade/">
        2023-02-17 Off2 Upgrade
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-02-24-zfs-introduction/">
        2023 02 24 zfs introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/2023-03-14-off2-reinstall/">
        2023-03 OFF2 reinstall
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#software-installation">
    Software installation
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mail">
    Mail
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#software-update">
    Software update
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#analytics-with-matomo">
    Analytics with Matomo
  </a>
<nav aria-label="Analytics with Matomo" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#setup">
    setup
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#events-plugin">
    Events plugin
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="discourse">Discourse<a class="headerlink" href="#discourse" title="Permanent link">#</a></h1>
<p><a href="https://www.discourse.org/">Discourse</a> is a forum application.</p>
<p>It is installed on our Proxmox infrastructure in a QEMU virtual machine (202).</p>
<h2 id="software-installation">Software installation<a class="headerlink" href="#software-installation" title="Permanent link">#</a></h2>
<p>Software is installed in <code>/var/discourse</code>.</p>
<p>We use the https://github.com/discourse/discourse_docker.git.</p>
<p>The docker configuration is contained in <code>config/app.yml</code></p>
<p>It creates a unique docker container containing whole application, postgresql and redis database, and so on!</p>
<p>It defines volumes where all the data is found. It's in <code>/var/discourse/shared/standalone</code> and mounted in container as <code>/shared</code></p>
<p>You might get a shell into the docker container using <code>./launcher enter app bash</code>.</p>
<h2 id="mail">Mail<a class="headerlink" href="#mail" title="Permanent link">#</a></h2>
<p>Mail is very important as a lot of notifications are sent by the forum.</p>
<p>Mail can be tested at https://forum.openfoodfacts.org/admin/email</p>
<p>We use <a href="../mail/">Promox mail gateway</a>.</p>
<p><strong>⚠ Warning:</strong> the sender email <a href="../mail/#only-domain">have to be on main domain</a>, NOT forum.openfoodfacts.org.</p>
<h2 id="software-update">Software update<a class="headerlink" href="#software-update" title="Permanent link">#</a></h2>
<p>Please respect the following procedure:</p>
<ol>
<li>Make a snapshot before upgrade.</li>
<li>Try to upgrade threw the web interface: https://forum.openfoodfacts.org/admin/upgrade (you need to be an admin)</li>
<li>Test the update during several days.</li>
<li>After several days, if everything is fine, you can delete the snapshot.</li>
</ol>
<p>While upgrading via the web interface, you could possibly get this error message:
<div class="highlight"><pre><span></span><code>You are running an old version of the Discourse image.

Upgrades via the web UI are disabled until you run the latest image.

To do so log in to your server using SSH and run:
        cd /var/discourse
        git pull
        ./launcher rebuild app
</code></pre></div>
In this case, you have to upgrade in a Linux shell directly on the VM:</p>
<ol>
<li>Get root access on ovh1: <code>sudo su root</code></li>
<li>Connect yourself to the VM: <code>ssh 10.1.0.202</code></li>
<li><code>cd /var/discourse</code></li>
<li><code>git pull</code></li>
<li><code>./launcher rebuild app</code></li>
</ol>
<h2 id="analytics-with-matomo">Analytics with Matomo<a class="headerlink" href="#analytics-with-matomo" title="Permanent link">#</a></h2>
<p>We setup analytics with Matomo on the forum.</p>
<p>There is a theme: https://meta.discourse.org/t/matomo-analytics/33090 <sup id="fnref:install_theme"><a class="footnote-ref" href="#fn:install_theme">1</a></sup></p>
<h3 id="setup">setup<a class="headerlink" href="#setup" title="Permanent link">#</a></h3>
<p>I created the website in Matomo. Site id is 8.</p>
<p>In Discourse:
* go to administration / Customize / theme
* install / from a git repository : https://github.com/discourse/discourse-matomo-analytics.git 
* Settings:
  * Include component on these themes: <strong>Default</strong>  (using button <em>add to all them</em>)
  * host url: <code>analytics.openfoodfacts.org</code>
  * website id: <strong>8</strong>
  * subdomain tracking: <strong>yes</strong>
  * do not track: <strong>yes</strong>
  * disable cookies: <strong>yes</strong> (keep GDPR compatibility)</p>
<p>Discourse is very specific in it's Content Security Policy headers, so we have to add an entry for Matomo.
* go to administration / settings / security
* in content security policy script src, add entry: <code>https://analytics.openfoodfacts.org/piwik.js</code></p>
<h2 id="events-plugin">Events plugin<a class="headerlink" href="#events-plugin" title="Permanent link">#</a></h2>
<p>Follow: https://meta.discourse.org/t/install-plugins-in-discourse/19157</p>
<ol>
<li>Get root access on ovh1: <code>sudo su root</code></li>
<li>Connect yourself to the VM: <code>ssh 10.1.0.202</code></li>
<li><code>cd /var/discourse</code></li>
<li><code>nano containers/app.yml</code></li>
<li>Add <a href="https://github.com/paviliondev/discourse-events.git">the plugin’s repository URL</a> to your container’s app.yml file, right after the <code>git clone https://github.com/discourse/docker_manager.git</code></li>
<li>Rebuild the app: <code>./launcher rebuild app</code></li>
</ol>
<p>Found this warning, ans solved by implementing its advice:
<code>WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</code></p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:install_theme">
<p>More info on how to install a theme: https://meta.discourse.org/t/install-a-theme-or-theme-component/63682 <a class="footnote-backref" href="#fnref:install_theme" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.51198bba.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>